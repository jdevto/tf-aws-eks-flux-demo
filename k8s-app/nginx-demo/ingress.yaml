# Canary Deployment Ingress for nginx-demo using shared ALB
# This Ingress supports canary traffic splitting via ALB weighted target groups
# Traffic is split between nginx-demo-stable (primary) and nginx-demo-canary (canary)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nginx-demo
  namespace: default
  annotations:
    # Use AWS Load Balancer Controller
    kubernetes.io/ingress.class: alb
    # Share ALB with other Ingresses using the same group name
    alb.ingress.kubernetes.io/group.name: demo-apps
    # Internet-facing ALB
    alb.ingress.kubernetes.io/scheme: internet-facing
    # Target type: IP (direct pod targeting)
    alb.ingress.kubernetes.io/target-type: ip
    # Health check configuration
    alb.ingress.kubernetes.io/healthcheck-path: /
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "15"
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
    alb.ingress.kubernetes.io/healthy-threshold-count: "2"
    alb.ingress.kubernetes.io/unhealthy-threshold-count: "2"
    # Load balancer attributes
    alb.ingress.kubernetes.io/load-balancer-attributes: idle_timeout.timeout_seconds=60
    # Canary traffic splitting using ALB weighted target groups
    # Adjust weights to control canary percentage (weights must sum to 100)
    # Current: 75% stable, 25% canary
    # To change: modify the weights below (e.g., 90/10, 50/50, etc.)
    alb.ingress.kubernetes.io/actions.nginx-canary: |
      {
        "Type": "forward",
        "ForwardConfig": {
          "TargetGroups": [
            {"ServiceName": "nginx-demo-stable", "ServicePort": "80", "Weight": 75},
            {"ServiceName": "nginx-demo-canary", "ServicePort": "80", "Weight": 25}
          ]
        }
      }
spec:
  rules:
    - http:
        paths:
          # Path-based routing: /nginx-demo/* routes to canary-weighted action
          - path: /nginx-demo
            pathType: Prefix
            backend:
              service:
                name: nginx-canary
                port:
                  name: use-annotation
